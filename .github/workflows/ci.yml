name: CI

on:
    pull_request:
        branches:
            - 'develop'
        types: [opened]
        paths:
            - '**'

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 6.x

    - name: Restore dependencies
      run: dotnet restore

    - name: Install Roslyn Analyzers
      run: |
        cd MarioGame
        dotnet add package Microsoft.CodeAnalysis.FxCopAnalyzers
        cd ..
        cd MarioGame.Tests
        dotnet add package Microsoft.CodeAnalysis.FxCopAnalyzers
        cd ..

    - name: Build
      run: |
        cd MarioGame
        dotnet build --no-restore
        cd ..
        cd MarioGame.Tests
        dotnet build --no-restore
        cd ..

    - name: Run tests
      run: |
        cd MarioGame.Tests
        dotnet test --no-restore --verbosity normal --collect:"XPlat Code Coverage"
        cd ..

    - name: Run Roslyn Analyzers Dev
      run: |
        cd MarioGame
        dotnet build --no-restore /p:RunAnalyzersDuringBuild=true /p:TreatWarningsAsErrors=true
        cd ..

    - name: Run Roslyn Analyzers Test
      run: |
        cd MarioGame.Tests
        dotnet build --no-restore /p:RunAnalyzersDuringBuild=true /p:TreatWarningsAsErrors=true
        cd ..

  format:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 6.x

    - name: Install dotnet format tool
      run: dotnet tool install -g dotnet-format

    - name: Add dotnet tools to PATH
      run: echo "/home/runner/.dotnet/tools" >> $GITHUB_PATH

    - name: Run dotnet format
      run: dotnet format --verify-no-changes
